services:
  sandbox:
    # Build from local Dockerfile.
    build:
      context: .
      dockerfile: Dockerfile
    # Fixed image/container names simplify attach/debug workflows.
    image: agent-sandbox:latest
    container_name: agent-sandbox
    hostname: sandbox
    # Keep stdin/tty open for interactive shell use.
    stdin_open: true
    tty: true
    # Keep container user aligned with host user when needed.
    # This helps rootless Docker socket setups where socket mode is 0600.
    # Defaults to sandbox UID/GID (1000:1000) for normal setups.
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"

    # Mount strategy
    volumes:
      # User's project directory → /workspace
      - ${TARGET_DIR:-.}:/workspace
      # Entire $HOME for sandbox user → persists all configs/auth/history
      - ${SANDBOX_HOME:-~/.agent-sandbox/home}:/home/sandbox
      # Docker socket forwarding (DooD — Docker-out-of-Docker):
      # Lets container use host Docker engine without running its own daemon.
      # Override DOCKER_SOCK if your socket is in a non-standard location.
      # Rootless example: DOCKER_SOCK=/run/user/<uid>/docker.sock
      - ${DOCKER_SOCK:-/var/run/docker.sock}:/var/run/docker.sock
      # SSH agent forwarding (optional):
      # - If host has SSH_AUTH_SOCK, container can reuse host SSH auth.
      # - Fallback /dev/null keeps compose config valid when not set.
      - ${SSH_AUTH_SOCK:-/dev/null}:/tmp/ssh-agent.sock:ro

    # Grant sandbox user access to Docker socket inside the container.
    # Find your Docker socket GID with: stat -c '%g' /var/run/docker.sock
    # Then run: DOCKER_GID=<gid> docker compose up
    # On macOS Docker Desktop this is typically 0; on Linux often 999 or 998.
    group_add:
      - ${DOCKER_GID:-0}

    environment:
      # Docker CLI inside container always talks to mounted socket path.
      - DOCKER_HOST=unix:///var/run/docker.sock
      # Point tools to forwarded SSH agent socket.
      - SSH_AUTH_SOCK=/tmp/ssh-agent.sock
      # API keys passed from host (never baked into image).
      - ANTHROPIC_API_KEY
      - OPENAI_API_KEY
      - GEMINI_API_KEY
      - GITHUB_TOKEN
      - OPENCODE_API_KEY
      # Proxy / TLS trust (important for corporate/VPN networks).
      - HTTP_PROXY
      - HTTPS_PROXY
      - NO_PROXY
      - http_proxy
      - https_proxy
      - no_proxy
      - ALL_PROXY
      - all_proxy
      - SSL_CERT_FILE
      - SSL_CERT_DIR
      - NODE_EXTRA_CA_CERTS
      # Node TLS compatibility: cap TLS to 1.2 and prefer IPv4 to avoid
      # UND_ERR_SOCKET / BAD_RECORD_MAC on unstable network paths.
      # Set AGENT_SANDBOX_NODE_TLS_COMPAT=0 on host to disable.
      - AGENT_SANDBOX_NODE_TLS_COMPAT=${AGENT_SANDBOX_NODE_TLS_COMPAT:-1}
      - "NODE_OPTIONS=${NODE_OPTIONS:---tls-max-v1.2 --tls-min-v1.2 --dns-result-order=ipv4first}"
      # Disable Claude telemetry/error reporting by default to reduce
      # network failure surface. Set to 0 on host to re-enable.
      - CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=${CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC:-1}
      - DISABLE_ERROR_REPORTING=${DISABLE_ERROR_REPORTING:-1}
      - DISABLE_TELEMETRY=${DISABLE_TELEMETRY:-1}

    # Security
    # Block privilege escalation inside container.
    security_opt:
      - no-new-privileges:true

    # Resource limits (deploy syntax works with docker compose v2+).
    mem_limit: 8g
    deploy:
      resources:
        limits:
          memory: 8g

    # Network: custom bridge with MTU 1400 to prevent TLS packet corruption
    # on VPN/VM/tunnel networks where path MTU < 1500.
    networks:
      - sandbox-net

networks:
  sandbox-net:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: "1400"
