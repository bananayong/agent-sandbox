name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request_review:
    types: [submitted]

jobs:
  # Issue resolution: @claude in issue title/body/comment → make changes and create PR
  claude-issue:
    if: |
      github.actor != 'github-actions[bot]' &&
      (
        (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude'))) ||
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && !github.event.issue.pull_request)
      )
    runs-on: ubuntu-latest
    timeout-minutes: 45
    concurrency:
      group: claude-issue-${{ github.event.issue.number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Validate actor allowlist
        id: allowlist
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        env:
          ALLOWED_ACTORS: ${{ secrets.AGENT_ALLOWED_ACTORS }}
        with:
          script: |
            const allowedRaw = (process.env.ALLOWED_ACTORS || '').trim();
            if (!allowedRaw) {
              core.setFailed('AGENT_ALLOWED_ACTORS secret is empty. Refusing to run.');
              return;
            }
            const allowed = new Set(
              allowedRaw.split(',').map(s => s.trim().toLowerCase()).filter(Boolean)
            );
            const actor = context.actor?.toLowerCase() || '';
            if (!actor || !allowed.has(actor)) {
              core.setFailed(`Actor ${actor || 'unknown'} is not allowlisted.`);
              return;
            }
            core.info(`Actor ${actor} is allowlisted.`);

      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@ea36d6abdedc17fc2a671b36060770b208a6f8f1 # v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are working on issue #${{ github.event.issue.number }} in this repository.
            Read the issue details with `gh issue view ${{ github.event.issue.number }}` and resolve it by making the necessary code changes.

            After making all changes:
            1. Create and switch to a new branch: `agent/issue-${{ github.event.issue.number }}`
            2. Stage and commit all changes with a descriptive message referencing the issue
            3. Push the branch to origin
            4. Create a pull request targeting the default branch that closes #${{ github.event.issue.number }}

            If no code changes are needed, just explain why in a comment.

  # PR interaction: @claude in PR comment/review → conversational response
  claude-pr:
    if: |
      github.actor != 'github-actions[bot]' &&
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && github.event.issue.pull_request) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Validate actor allowlist
        id: allowlist
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        env:
          ALLOWED_ACTORS: ${{ secrets.AGENT_ALLOWED_ACTORS }}
        with:
          script: |
            const allowedRaw = (process.env.ALLOWED_ACTORS || '').trim();
            if (!allowedRaw) {
              core.setFailed('AGENT_ALLOWED_ACTORS secret is empty. Refusing to run.');
              return;
            }
            const allowed = new Set(
              allowedRaw.split(',').map(s => s.trim().toLowerCase()).filter(Boolean)
            );
            const actor = context.actor?.toLowerCase() || '';
            if (!actor || !allowed.has(actor)) {
              core.setFailed(`Actor ${actor || 'unknown'} is not allowlisted.`);
              return;
            }
            core.info(`Actor ${actor} is allowlisted.`);

      - name: Skip unsupported foreign fork PR context
        id: pr_guard
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const event = context.eventName;
            const payload = context.payload;
            const currentRepo = `${context.repo.owner}/${context.repo.repo}`;
            let headRepo = '';

            if (event === 'issue_comment') {
              const prNumber = payload.issue?.number;
              if (prNumber) {
                const pr = await github.rest.pulls.get({
                  ...context.repo,
                  pull_number: Number(prNumber),
                });
                headRepo = pr.data.head?.repo?.full_name || '';
              }
            } else if (event === 'pull_request_review_comment' || event === 'pull_request_review') {
              headRepo = payload.pull_request?.head?.repo?.full_name || '';
            }

            if (headRepo && headRepo !== currentRepo) {
              core.info(`Skip: foreign fork PR head repo ${headRepo} is not supported.`);
              core.setOutput('should_run', 'false');
              return;
            }

            core.setOutput('should_run', 'true');

      - name: Checkout repository
        if: steps.pr_guard.outputs.should_run == 'true'
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        if: steps.pr_guard.outputs.should_run == 'true'
        id: claude
        uses: anthropics/claude-code-action@ea36d6abdedc17fc2a671b36060770b208a6f8f1 # v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_tools: "Bash(git:*),Bash(gh:*)"
          settings: |
            {
              "permissions": {
                "allow": [
                  "Bash(git:*)",
                  "Bash(gh:*)"
                ]
              }
            }
          additional_permissions: |
            actions: read
