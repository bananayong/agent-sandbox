name: Update Pinned Versions

on:
  schedule:
    - cron: "17 5 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: update-pinned-versions
  cancel-in-progress: true

jobs:
  update-pins:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Update pinned versions
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          max_attempts=3
          attempt=1

          while [[ "${attempt}" -le "${max_attempts}" ]]; do
            echo "Running pinned version update (attempt ${attempt}/${max_attempts})..."
            if bash scripts/update-versions.sh update; then
              exit 0
            fi

            if [[ "${attempt}" -eq "${max_attempts}" ]]; then
              echo "Pinned version update failed after ${max_attempts} attempts." >&2
              exit 1
            fi

            sleep_seconds=$((attempt * 10))
            echo "Retrying in ${sleep_seconds}s..." >&2
            sleep "${sleep_seconds}"
            attempt=$((attempt + 1))
          done

      - name: Detect changes
        id: diff
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> "${GITHUB_OUTPUT}"
            echo "No pinned version updates found."
          else
            echo "has_changes=true" >> "${GITHUB_OUTPUT}"
            echo "Pinned version updates detected."
            git status --short
          fi

      - name: Create pull request
        if: steps.diff.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8
        with:
          token: ${{ github.token }}
          commit-message: "chore: update pinned versions"
          branch: "automation/update-pinned-versions"
          delete-branch: true
          title: "chore: update pinned versions"
          body: |
            Automated pinned version updates generated by `.github/workflows/update-pinned-versions.yml`.

            Command run:
            - `bash scripts/update-versions.sh update`
          labels: |
            dependencies
            automation
