name: Update External Skills

on:
  schedule:
    - cron: "43 5 * * 3"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: update-external-skills
  cancel-in-progress: true

jobs:
  refresh-external-skills:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Refresh vendored external skills
        run: |
          set -euo pipefail

          max_attempts=3
          attempt=1
          while [[ "${attempt}" -le "${max_attempts}" ]]; do
            echo "Refreshing external skills (attempt ${attempt}/${max_attempts})..."
            if bash scripts/vendor-external-skills.sh; then
              break
            fi

            if [[ "${attempt}" -eq "${max_attempts}" ]]; then
              echo "External skill refresh failed after ${max_attempts} attempts." >&2
              exit 1
            fi

            sleep_seconds=$((attempt * 10))
            echo "Retrying in ${sleep_seconds}s..." >&2
            sleep "${sleep_seconds}"
            attempt=$((attempt + 1))
          done

      - name: Validate shared skills policy
        run: |
          set -euo pipefail
          SMOKE_TEST_SOURCE=repo bash scripts/smoke-test.sh --build

      - name: Detect changes
        id: diff
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> "${GITHUB_OUTPUT}"
            echo "No external skill updates detected."
          else
            echo "has_changes=true" >> "${GITHUB_OUTPUT}"
            echo "External skill updates detected."
            git status --short
          fi

      - name: Create pull request
        if: steps.diff.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8
        with:
          token: ${{ github.token }}
          commit-message: "chore: refresh external skills bundle"
          branch: "automation/update-external-skills"
          delete-branch: true
          title: "chore: refresh external skills bundle"
          body: |
            Automated external skills refresh generated by `.github/workflows/update-external-skills.yml`.

            Commands run:
            - `bash scripts/vendor-external-skills.sh`
            - `SMOKE_TEST_SOURCE=repo bash scripts/smoke-test.sh --build`
          labels: |
            dependencies
            automation
